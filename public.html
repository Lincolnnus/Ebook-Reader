<!doctype HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Public Books</title>
    <link rel="stylesheet" href="css/index.css"/> 
    <style type="text/css">
	#viewerContainer {
	  overflow: auto;
	  box-shadow: inset 1px 0 0 hsla(0,0%,100%,.05);
	  padding-top: 30px;
	  position: absolute;
	  top: 32px;
	  right: 0;
	  bottom: 0;
	  left: 0;
	}
	#loginWrapper {
	  background-color: #F9F9F9;
	  border: 1px solid #6B7B95;
	  color: #000;
	  float: left;
	  height: 120px;
	  padding: 10px;
	  width: 400px;
	  position:absolute;
	  left:30%;
	  top:20%;
	  z-index:2;
	}
	#errorWrapper {
	  background-color: #F9F9F9;
	  border: 1px solid #6B7B95;
	  color: #000;
	  float: left;
	  height: 120px;
	  padding: 10px;
	  width: 400px;
	  position:absolute;
	  left:30%;
	  top:20%;
	  z-index:3;
	}
	#bookdetail {
	  border: 1px solid #6B7B95;
	  background-color:#F9F9F9;
	  z-index:10;
	  position:absolute;
	}
	.bookmeta{
	  position:absolute;
	}
	.selected{
	  background-color: #F9F9F9;
	}
    </style>
    <!--Get mootools-->
    <script src="js/mootools-core.js" type="text/javascript"></script>
    <script src="js/mootools-more.js" type="text/javascript"></script>
    <script src="js/cookie.js"></script>
    <script type="text/javascript">
        var IP="api";
	var thumbnailurl="http://localhost/viewer/pdfimage/";
	var pdfurl="http://localhost/viewer/pdf";
	var readurl="http://localhost/viewer/read.html";
	function getParameterByName(name)
	{
	  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	  var regexS = "[\\?&]" + name + "=([^&#]*)";
	  var regex = new RegExp(regexS);
	  var results = regex.exec(window.location.search);
	  if(results == null)
	    return "";
	  else
	    return decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	function socialLogin()
	{
		switch($("social").value)
		{
			case 'facebook':
			window.location="fb.php";
			break;
			case 'renren':
			break;
		}
	}
	function getStoreBooks()
	{
		var jsonRequest = new Request.JSON({url: 'api/store.php', onSuccess: function(upload){
		    for(var i=0;i<upload.length;i++)
		    {
			var book=upload[i];
			// Creating an new anchor with an Object
			var wid=window.innerWidth;
			var hei=window.innerHeight;
			var newbook = new Element('li', {
			    id:i,
			    'class': 'bookmeta',
			    html:'',
			    styles: {
				'background-image':'url('+thumbnailurl+book.thumbnail+')',
				'background-size':wid/6+'px',
				'background-repeat':'no-repeat',
				'width':wid/5,
				'height':hei/3,
				'display': 'block',
				'left':(i%4)*wid/4+wid/30,
				'top':Math.floor(i/4)*hei/2+hei/30,
			    },
			    events: {
				click: function(){
				   window.location=readurl+'?bid='+upload[this.id].bid;
				},
				mouseover: function(e){
				    e.stop(e);
				    $('booktitle').set('html','Title:'+upload[this.id].title);
				    $('bookauthor').set('html','Author:'+upload[this.id].author);
				    $('bookdetail').show();
				    $('bookdetail').setStyles({
					    'width':this.style.width,
					    'height':this.style.height,
					    'left':e.event.clientX,
					    'top':e.event.clientY
					});	
				},
				mouseleave:function()
				{
				    $('bookdetail').hide();
				}			
			    }
			}).inject($("books"));
		    }
		}}).get();
	}
	function userLogout()
	{
		deleteAllCookies();
		window.location.reload();
	}
 	window.addEvent('domready', function() {
	 $('errorWrapper').hide();
	 $('loginWrapper').hide();
	 if(checkCookie('uid')!=""){ 
		$('login').set('html',''); 
		var myimg=new Element('img',{'width':'20px','src':getCookie('thumnail')}).inject($('login')); 
		var clicked=false; 
		myimg.addEvent('click',function(){
			if(!clicked){
			var myaccount=new Element('div',{'html':'My Account'}).inject($('login'));
			myaccount.addEvent('click',function(){window.location="account.html"});
			var logout=new Element('div',{'html':'logout'}).inject($('login'));
			logout.addEvent('click',function(){userLogout();});
			clicked=true;
			}
		});
		}
	 else { $('login').addEvent('click', function(){
	    	$('loginWrapper').show();
	        $('cancel').show();
		  });
		$('cancel').addEvent('click', function(){
		    $('loginWrapper').hide();
		    $(this).hide();
		  });
	     }
	 getStoreBooks();
	 $('bookdetail').hide();
	
	$('confirmLogin').addEvent('click', function(){
	    var email=$('email').value;
	    var password=$('password').value;
	    var jsonRequest = new Request.JSON({url: 'api/login.php', 
			onSuccess: function(user){
			if(user.code) 
			{$('cancel2').show(); $('errorWrapper').show(); $('errormsg').set('html',user.msg);} 
			else { setCookie('firstname',user.firstname,1);setCookie('uid',user.uid,1);setCookie('thumnail',user.avatar_url,1);window.location="index.html";}}
		}).post({'email':email,'password':password});
	  });
	$('cancel2').addEvent('click', function(){
	    $('errorWrapper').hide();
	    $(this).hide();
	  });
	});
    </script>
</head>
<body>
<div>
    <div id="outerContainer">
	<div class="toolbar">
		<div id="toolbarLeft">
                        <a id="library">library</a>	  
		</div>
		<div id="toolbarRight">
			<div id="login" class="upload" title="Login" tabindex="12" data-l10n-id="open_file">
			Login
			</div>
		</div>
		<div id="toolbarCenter">
			Public Books
		</div>
        </div>
        <div id="viewerContainer">
		 <div id="loginWrapper">
			<a style="float:right;" id="cancel">Close</a>
			<fieldset>
				<legend>Login</legend>

				<div>
					<label for="email">email: </label>
					<input type="text" name="email" id="email"><br>
					<label for="password">password: </label>
					<input type="password" name="password" id="password"><br>
				</div>

				<div>
					<button id="confirmLogin">Login</button>
				</div>
				<select onclick="socialLogin()" id="social" style="float:right;">
					<option value="">Login With...</option>
					<option value="facebook"> facebook</option>
					<option value="twitter">twitter</option>
					<option value="renren">人人</option>
					<option value="sina">新浪</option>
				</select>
			</fieldset>
		 </div>
 		<div id="errorWrapper">
			<a style="float:right;" id="cancel2">Close</a>
			<fieldset>
				<legend>Error</legend>
				<div id="errormsg"> </div>
			</fieldset>
		 </div>
		 <div>
			<ul id="books">
			</ul>
		 </div>
		 <div id="bookdetail">
			<ul>
			<li id="booktitle"></li>
			<li id="bookauthor"></li>
			</ul>
		 </div>
	</div>
	<div>
	</div>
    </div>
</div>
</body>
</html>
